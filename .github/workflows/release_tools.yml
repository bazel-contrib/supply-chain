name: "Create release of tools"

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: "string"

permissions:
  id-token: write
  attestations: write
  contents: write

jobs:
  ci:
    name: "CI"
    uses: "./.github/workflows/ci.yml"
  
  create_tag:
    name: "Create tag"
    runs-on:
      - "ubuntu-latest"
    needs:
      - "ci"

    steps:
      - uses: actions/checkout@v6

      - name: "Create tag"
        id: "tag"
        env:
          VERSION: "${{ inputs.version }}"

          GIT_AUTHOR_NAME: "${{ github.actor }}"
          GIT_AUTHOR_EMAIL: "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          GIT_COMMITTER_NAME: "${{ github.actor }}"
          GIT_COMMITTER_EMAIL: "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
        run: |

          # Download `buildozer`
          #
          # TODO(yannic): Use `RUNNER_TOOL_CACHE` and cache between runs?
          curl -o "${RUNNER_TEMP}/buildozer" -L "https://github.com/bazelbuild/buildtools/releases/download/v7.3.1/buildozer-linux-amd64"
          chmod +x "${RUNNER_TEMP}/buildozer"
          # Update `MODULE.bazel` and commit.
          bzlmod_names=("supply_chain_tools")
          bzlmod_directories=("tools")

          for bzlmod_directory in "${bzlmod_directories[@]}"; do
            for bzlmod_name in "${bzlmod_names[@]}"; do
              "${RUNNER_TEMP}/buildozer" "set version ${VERSION}" "//${bzlmod_directory}/MODULE.bazel:${bzlmod_name}" || true
            done
            git add "${bzlmod_directory}/MODULE.bazel"
          done
          git commit -m "Release `supply_chain-tools-${VERSION}`"

          # Push release tag.
          git tag "supply_chain-tools-${VERSION}" "HEAD"
          git push origin "supply_chain-tools-${VERSION}"

  release:
    name: "Create GitHub release"
    needs:
      - "create_tag"

    uses: "bazel-contrib/.github/.github/workflows/release_ruleset.yaml@v7.2.4"
    with:
      # The workflow appends `--disk_cache` here. There seems to be now way to
      # opt out, so use `echo || false` to make it a noop.
      bazel_test_command: echo "Already executed by step 'CI'" || false
      release_files: "supply_chain_tools-*.tar.gz"
      prerelease: "true"
      tag_name: "supply_chain_tools-${{ inputs.version }}"

# Next PR, after we test process.
#  publish:
#    name: "Publish to BCR"
#    needs:
#      - "release"
#
#    permissions:
#      attestations: write
#      contents: write
#      id-token: write
#
#    uses: "bazel-contrib/publish-to-bcr/.github/workflows/publish.yaml@v1.0.0"
#    with:
#      tag_name: "supply_chain-tools-${{ inputs.version }}"
#      registry_fork: "bazel-contrib/bazel-central-registry"
#      draft: false
#    secrets:
#      publish_token: "${{ secrets.BCR_PUBLISH_TOKEN }}"
