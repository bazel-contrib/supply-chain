name: "Create release"

on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: "string"

permissions:
  id-token: write
  attestations: write
  contents: write

jobs:
  ci:
    name: "CI"
    uses: "./.github/workflows/ci.yaml"
  
  create_tag:
    runs-on:
      - "ubuntu-latest"
    needs:
      - "ci"

    steps:
      - uses: actions/checkout@v4

      - name: Create tag
        id: "tag"
        env:
          VERSION: "${{ inputs.version }}"
        run: |
          # 1. Download `buildozer`
          curl -o "${RUNNER_TEMP}/buildozer" -L "https://github.com/bazelbuild/buildtools/releases/download/v7.3.1/buildozer-linux-amd64"
          chmod +x "${RUNNER_TEMP}/buildozer"

          # 2. Update `MODULE.bazel` and commit.
          #
          # TODO(yannic): Read directories from `//.bcr:config.yaml`.
          bzlmod_names=("supply-chain-docs" "package_metadata" "supply-chain-go")
          bzlmod_directories=("docs" "lib/supplychain-go" "metadata")

          for bzlmod_directory in "${bzlmod_directories[@]}"; do
            for bzlmod_name in "${bzlmod_names[@]}"; do
              "${RUNNER_TEMP}/buildozer" "set version ${VERSION}" "//${bzlmod_directory}/MODULE.bazel:${bzlmod_name}" || true
            done

            git add "${bzlmod_directory}/MODULE.bazel"
          done
          git commit -m "Release ${VERSION}"

          # 3. Push release tag.
          git tag "${VERSION}" "HEAD"
          git push origin "${VERSION}"
